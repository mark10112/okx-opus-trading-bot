name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Lint â€” Ruff check + format check (all repos)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Ruff
        run: pip install "ruff>=0.4"

      - name: Ruff check
        run: |
          ruff check indicator-trade-server/src indicator-trade-server/tests
          ruff check orchestrator/src orchestrator/tests
          ruff check ui/src ui/tests

      - name: Ruff format check
        run: |
          ruff format --check indicator-trade-server/src indicator-trade-server/tests
          ruff format --check orchestrator/src orchestrator/tests
          ruff format --check ui/src ui/tests

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect which sub-repos changed (PR only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      indicator-trade: ${{ steps.filter.outputs.indicator-trade }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            indicator-trade:
              - 'indicator-trade-server/**'
            orchestrator:
              - 'orchestrator/**'
            ui:
              - 'ui/**'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Test â€” indicator-trade-server
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-indicator-trade:
    name: Test indicator-trade-server
    runs-on: ubuntu-latest
    needs: [lint, changes]
    if: >-
      github.event_name == 'push' ||
      needs.changes.outputs.indicator-trade == 'true'
    defaults:
      run:
        working-directory: indicator-trade-server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: indicator-trade-server/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          python -m pytest tests/unit/ -v \
            --cov=indicator_trade \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=80 \
            --junitxml=junit.xml

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: indicator-trade-server/coverage.xml
          junitxml-path: indicator-trade-server/junit.xml
          title: "ðŸ“Š indicator-trade-server coverage"
          unique-id-for-comment: indicator-trade

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Test â€” orchestrator
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-orchestrator:
    name: Test orchestrator
    runs-on: ubuntu-latest
    needs: [lint, changes]
    if: >-
      github.event_name == 'push' ||
      needs.changes.outputs.orchestrator == 'true'
    defaults:
      run:
        working-directory: orchestrator
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: orchestrator/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          python -m pytest tests/unit/ -v \
            --cov=orchestrator \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=80 \
            --junitxml=junit.xml

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: orchestrator/coverage.xml
          junitxml-path: orchestrator/junit.xml
          title: "ðŸ“Š orchestrator coverage"
          unique-id-for-comment: orchestrator

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Test â€” ui
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-ui:
    name: Test ui
    runs-on: ubuntu-latest
    needs: [lint, changes]
    if: >-
      github.event_name == 'push' ||
      needs.changes.outputs.ui == 'true'
    defaults:
      run:
        working-directory: ui
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: ui/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          python -m pytest tests/unit/ -v \
            --cov=ui \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=80 \
            --junitxml=junit.xml

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: ui/coverage.xml
          junitxml-path: ui/junit.xml
          title: "ðŸ“Š ui coverage"
          unique-id-for-comment: ui
